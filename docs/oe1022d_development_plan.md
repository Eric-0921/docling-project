# OE1022D 锁相放大器知识库开发方案

## 1. 项目背景与目标
本项目旨在利用 Docling 技术，从《OE1022D DSP Lock-In Amplifier 远程控制说明书》PDF 中提取结构化知识，构建用于 AI 控制的知识库。
**核心挑战**：
- **控制协议差异**：与之前的 SMB100A（SCPI）不同，OE1022D 使用 ASCII 编码，指令结构（特别是大写字母指令+数字参数）需要新的解析逻辑。
- **文档结构复杂**：文档大量依赖“宽表”和“长表”来描述指令及其参数映射，对表格识别精度要求极高。
- **项目管理要求**：需确保新设备的开发不影响原有 SMB100A 的代码稳定性，实现代码隔离。

## 2. 技术路线与解决方案

### 2.1 核心挑战解决方案：复杂表格识别
**问题**：PDF 中包含大量“左侧指令-右侧说明”的布局，以及嵌套参数表（如 FPOPD 指令的 k 值映射）。
**方案**：利用 Docling 集成的 **TableFormer** 模型（Hugging Face 优化版）。
- **模型配置**：
  - 启用 `TableFormerMode.ACCURATE`：这是 Docling 目前最强的表格结构识别模式，专门处理复杂边框和合并单元格。
  - 启用 `do_cell_matching=True`：确保表格内容与 PDF 原始文本块精确对齐，避免OCR导致的字符漂移。
  - **增强预处理**：针对特定页码（如64, 65, 77页），我们将配置 Docling 以高分辨率渲染页面图像，辅助模型识别细微的分隔线。

### 2.2 核心挑战解决方案：ASCII 指令解析
**问题**：原有的 SCPI 解析器寻找 `*IDN?` 或 `:SOURce: FREQ` 这种特定模式，无法识别 OE1022D 的 `SENS D 25`。
**方案**：**新一代知识构建器 (Knowledge Builder V3)**。
- 我们不直接修改旧代码，而是引入**策略模式 (Strategy Pattern)**。
- **Parsing Strategy**：
  - `Smb100aStrategy`：保留原有的 SCPI 正则逻辑。
  - `Oe1022dStrategy`（新增）：
    - 识别规则：`[大写字母]{3,}[ ]+[大写字母]*`（例如 `SENS D`）。
    - 识别表格驱动的定义：检测到“Command”和“Description”列头的表格时，自动进入“表格提取模式”，将每一行视为一条独立指令。

### 2.3 代码架构与隔离方案 (Code Isolation)
为了回应您的顾虑，我们将严格隔离不同设备的代码，避免“牵一发而动全身”。

**目录结构规划**：
```text
docling_pipeline/
├── config/
│   ├── rules_smb100a.yaml   # SMB100A 专用规则
│   └── rules_oe1022d.yaml   # [NEW] OE1022D 专用规则
├── strategies/
│   ├── __init__.py
│   ├── scpi_strategy.py     # [REFACTOR] 提取出的 SCPI 逻辑
│   └── ascii_table_strategy.py # [NEW] 针对 OE1022D 的表格解析逻辑
└── scripts/
    ├── knowledge_builder_v3.py # [MODIFIED] 通用主程序，加载 Strategy
    └── run_oe1022d.sh       # [NEW] 专用启动脚本
```
**优势**：
- **零干扰**：SMB100A 的运行完全不受影响，只需指定使用 `rules_smb100a.yaml`。
- **灵活性**：未来增加第三台设备时，只需增加一个新的 YAML 配置文件和一个 Strategy 类。

## 3. 风险评估与应对 (Risk & Mitigation)

| 潜在风险 | 可能性 | 严重性 | 应对方案 |
| :--- | :--- | :--- | :--- |
| **OCR 误读单位** (如 `μ` 读成 `u` 或 `m`) | 高 | 高 | **后处理修正字典**：建立针对物理单位的 regex 替换表，强制修正 `uV` -> `μV`，`nV/fA` 等常见错误。 |
| **跨页长表格截断** | 中 | 中 | Docling 已支持表格延续识别，我们将编写脚本检测“孤儿表头”，将跨页表格的数据行自动合并到上一条指令中。 |
| **参数映射表丢失键值对** | 中 | 高 | **校验脚本**：编写专门的验证器，检查类似 `0...27` 的序列是否连续。如果有断档，自动报警提示人工介入。 |

## 4. 开发计划

1.  **环境准备**：确认本地 GPU (NVIDIA A4000) 显存足以运行 `TableFormer` 高精度模式。
2.  **原型验证 (Prototyping)**：
    - 仅针对 PDF 的第 62-82 页运行转换。
    - 评估 Docling 输出的 JSON 结构，确认表格是否被正确识别为 `TableItem`。
3.  **解析器开发**：编写 `Oe1022dStrategy`，重点攻克表格转指令的逻辑。
4.  **知识库生成与验证**：生成 Markdown，并与 Grok 提供的注意事项进行人工比对。

此方案确保了利用现有成熟的 Docling 成果，同时通过架构设计解决了代码耦合问题。
